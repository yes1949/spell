<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>è®°å¿†åŸå‹ Final V6</title>
  <style>
    :root {
      --primary: #5ac8fa;
      --active-blue: #007aff;
      --danger: #ff3b30;
      --bg-color: #f2f2f7;
      --card-bg: #ffffff;
      --bubble-bg: #81cafa;
      --btn-radius: 18px;
      --nav-height: 50px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: calc(var(--nav-height) + env(safe-area-inset-top));
      padding-top: env(safe-area-inset-top);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-bottom: 0.5px solid #c6c6c8;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .nav-item {
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      font-weight: 500;
    }
    .nav-item.active { color: var(--active-blue); font-weight: 700; }
    .nav-icon { font-size: 18px; margin-bottom: 2px; }

    /* --- ä¸»å†…å®¹åŒº --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      margin-top: calc(var(--nav-height) + env(safe-area-inset-top));
      padding-bottom: env(safe-area-inset-bottom); 
      overflow-y: hidden;
    }

    .page {
      display: none;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }
    .page.active { display: flex; }

    button {
      border: none;
      outline: none;
      background: var(--primary);
      color: white;
      font-size: 14px;
      font-weight: 600;
      padding: 0;
      border-radius: var(--btn-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    button:active { opacity: 0.7; }

    /* ================= ç¬¬ä¸€é¡µï¼šç´§å‡‘æ‹¼å†™ ================= */
    .top-controls {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .pill-btn {
      flex: 1;
      height: 36px;
      border-radius: 18px;
      font-size: 13px;
      position: relative;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      white-space: nowrap;
    }

    #groupSelectorSelect {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; z-index: 10; cursor: pointer;
    }
    #groupBtnLabel { pointer-events: none; z-index: 5; padding: 0 4px; text-overflow: ellipsis; overflow: hidden; }

    .prompt-area {
      background: #e1f5fe;
      color: #1c1c1e;
      border-radius: 16px;
      padding: 12px 15px;
      min-height: 60px;   
      max-height: 100px; 
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }

    .input-wrapper {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      margin-bottom: 0;
    }

    #wordInput {
      width: 100%;
      border: none;
      border-bottom: 2px solid #c7c7cc;
      font-size: 28px;
      text-align: center;
      padding: 4px 0;
      background: transparent;
      outline: none;
      color: #000;
      border-radius: 0;
      font-family: monospace;
      margin-top: 5px;
    }
    #wordInput:focus { border-bottom-color: var(--active-blue); }

    /* è¿›åº¦æ˜¾ç¤º */
    .progress-text {
      font-size: 12px;
      color: #999;
      text-align: center;
      height: 16px;
      line-height: 16px;
      margin-top: 8px;
      margin-bottom: 2px;
      font-variant-numeric: tabular-nums; 
    }

    /* åº•éƒ¨æŒ‰é’® */
    .bottom-actions {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 10px;
      padding-bottom: 10px;
    }
    
    .bottom-btn {
      flex: 1;
      height: 44px;
      border-radius: 22px;
      font-size: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    /* ================= ç¬¬äºŒé¡µï¼šå½•å…¥ ================= */
    .input-page-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-bottom: 10px;
    }

    #rawInput {
      height: 33vh; 
      flex: none;
      width: 100%;
      background: #ffffff;
      border: 1px solid #e5e5ea;
      border-radius: 16px;
      padding: 15px;
      font-size: 16px;
      line-height: 1.5;
      resize: none;
      outline: none;
      margin-bottom: 15px;
      color: #333;
    }

    .save-btn {
      width: 100%;
      height: 48px;
      font-size: 16px;
      border-radius: 24px;
      background: var(--active-blue);
    }

    /* ================= ç¬¬ä¸‰é¡µï¼šé”™é¢˜ ================= */
    #bubbleContainer {
      flex: 1;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      align-content: center; /* ä¸­é—´åä¸‹ */
      gap: 10px;
      justify-content: center;
      overflow: hidden;
      padding-bottom: 20px;
    }

    .bubble {
      background: var(--bubble-bg);
      color: white;
      padding: 8px 16px;
      border-radius: 18px;
      font-size: 14px;
      cursor: pointer;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s;
    }
    .bubble.selected {
      background: var(--active-blue);
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,122,255,0.4);
    }

    .error-bottom-actions {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      padding-bottom: 10px;
      margin-top: auto; 
    }

    #fileInput { display: none; }
    #feedbackDisplay { display: none; } 
  </style>
</head>
<body>

  <div class="top-nav">
    <div class="nav-item active" onclick="switchPage('drill')">
      <span class="nav-icon">ğŸ“</span>
      <span>ç»ƒä¹ </span>
    </div>
    <div class="nav-item" onclick="switchPage('input')">
      <span class="nav-icon">â•</span>
      <span>å½•å…¥</span>
    </div>
    <div class="nav-item" onclick="switchPage('errors')">
      <span class="nav-icon">ğŸ§¼</span>
      <span>é”™é¢˜å¢™</span>
    </div>
  </div>

  <div class="main-content" id="mainContainer">

    <div id="page-drill" class="page active">
      <div class="top-controls">
        <button class="pill-btn" id="btnImport">å¯¼å…¥</button>
        <div class="pill-btn">
          <span id="groupBtnLabel">é€‰æ‹©åˆ†ç»„</span>
          <select id="groupSelectorSelect"></select>
        </div>
        <button class="pill-btn" id="btnDelGroup">åˆ ç»„</button>
        <button class="pill-btn" id="btnSmartReview">å¤ä¹  <span id="reviewCount" style="display:none;font-weight:800;margin-left:3px;color:#fff000"></span></button>
      </div>

      <div class="prompt-area" id="definitionDisplay">è¯·é€‰æ‹©åˆ†ç»„</div>
      
      <div class="input-wrapper">
        <input type="text" id="wordInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="" />
      </div>
      
      <div id="progressDisplay" class="progress-text">0 / 0</div>

      <div class="bottom-actions">
        <button class="bottom-btn" id="btnDeleteWord" style="background:var(--danger); box-shadow:0 3px 8px rgba(255,59,48,0.2)">ğŸ—‘ï¸ åˆ é™¤</button>
        <button class="bottom-btn" id="btnTravel" style="background:var(--primary)">ğŸš€ ç©¿è¶Š</button>
      </div>
      <input type="file" id="fileInput" accept=".txt">
    </div>

    <div id="page-input" class="page">
      <div class="input-page-container">
        <textarea id="rawInput" placeholder="åœ¨æ­¤ç²˜è´´...&#10;æ ¼å¼ï¼šå•è¯,å®šä¹‰"></textarea>
        <button class="save-btn" id="btnConfirmInput">ä¿å­˜åˆ°æ–°åˆ†ç»„</button>
      </div>
    </div>

    <div id="page-errors" class="page">
      <div id="bubbleContainer"></div>
      <div class="error-bottom-actions">
        <button class="bottom-btn" id="btnErrorDelete" style="background:var(--danger); flex:1">åˆ é™¤é€‰ä¸­</button>
        <button class="bottom-btn" id="btnErrorTravel" style="background:var(--primary); flex:1">ç©¿è¶Šé€‰ä¸­</button>
      </div>
    </div>
  </div>

<script>
  // --- é…ç½®ä¸æ•°æ®ç»“æ„ ---
  const REVIEW_INTERVALS = [0, 1, 2, 4, 7, 15, 30, 60, 90, 120];
  
  // æŒä¹…åŒ–å˜é‡
  let wordLibrary = {};      // å®¹å™¨A (åŠ¨æ€)
  let wordLibrary_copy = {}; // å®¹å™¨B (å¤‡ä»½/åˆ†æ¯)
  let errorBook = [];        // å®¹å™¨E (é”™é¢˜)
  
  // è¿è¡Œæ—¶çŠ¶æ€
  let currentQueue = [];     // å†…å­˜ä¸­çš„å½“å‰æ‹¼å†™æ± 
  let currentGroupName = ""; // å½“å‰ç»„å
  let isReviewMode = false;  // æ˜¯å¦å¤„äºå¤ä¹ æ¨¡å¼
  let activeWord = null;     // å½“å‰æ˜¾ç¤ºçš„å•è¯å¯¹è±¡
  let selectedErrorWord = null;

  const pages = ['drill', 'input', 'errors'];
  let currentPageIndex = 0;

  // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ—¥æœŸKey ---
  function getTodayKey() {
    const now = new Date();
    const Y = now.getFullYear();
    const M = String(now.getMonth()+1).padStart(2,'0');
    const D = String(now.getDate()).padStart(2,'0');
    return `review_${Y}${M}${D}`;
  }

  // --- è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—éœ€å¤ä¹ å•è¯ ---
  function calcDueWords() {
    const now = Date.now();
    return errorBook.filter(w => {
        const stage = w.stage || 0;
        const intervalDays = stage < REVIEW_INTERVALS.length ? REVIEW_INTERVALS[stage] : 120;
        // é—´éš”æ—¶é—´åˆ¤æ–­ï¼šå½“å‰æ—¶é—´ - ä¸Šæ¬¡æ—¶é—´ >= é—´éš” * 24å°æ—¶
        return (now - w.lastReview) >= (intervalDays * 86400000);
    });
  }

  // --- æ¯æ—¥åˆå§‹åŒ– (Day Start) ---
  function checkDailyReviewInit() {
    const todayKey = getTodayKey();
    const stored = localStorage.getItem(todayKey);
    // å¦‚æœä»Šå¤©è¿˜æ²¡åˆå§‹åŒ–è¿‡ï¼Œè‡ªåŠ¨è®¡ç®—å¹¶å­˜å‚¨
    if (!stored) {
        const dueWords = calcDueWords();
        localStorage.setItem(todayKey, JSON.stringify(dueWords));         // å®¹å™¨C
        localStorage.setItem(todayKey + '_copy', JSON.stringify(dueWords)); // å®¹å™¨D
    }
  }

  // --- æ•°æ®æŒä¹…åŒ– ---
  function loadData() {
    const data = localStorage.getItem("myCardsData_Final_V6");
    if (data) {
      const parsed = JSON.parse(data);
      wordLibrary = parsed.wordLibrary || {};
      wordLibrary_copy = parsed.wordLibrary_copy || {}; // è¯»å–å¤‡ä»½åº“
      errorBook = parsed.errorBook || [];
      
      // å…¼å®¹æ€§ä¿®å¤
      errorBook.forEach(w => {
        if (!w.lastReview) w.lastReview = Date.now();
        if (typeof w.stage === 'undefined') w.stage = 0;
      });
      
      // æ¢å¤çŠ¶æ€
      currentQueue = parsed.currentQueue || [];
      currentGroupName = parsed.currentGroupName || "";
      isReviewMode = parsed.isReviewMode || false;
      activeWord = parsed.activeWord || null;
    }
    // æ¯æ¬¡åŠ è½½éƒ½æ£€æŸ¥æ—¥æœŸåˆå§‹åŒ–
    checkDailyReviewInit();
  }

  function saveData() {
    const data = { 
        wordLibrary, 
        wordLibrary_copy, 
        errorBook, 
        currentQueue, 
        currentGroupName, 
        isReviewMode, 
        activeWord 
    };
    localStorage.setItem("myCardsData_Final_V6", JSON.stringify(data));
    updateReviewBadge(); // æ›´æ–°å¤ä¹ è§’æ ‡
  }

  // --- é¡µé¢åˆ‡æ¢ & æ»‘åŠ¨ ---
  function switchPage(pageName) {
    const idx = pages.indexOf(pageName);
    if(idx !== -1) currentPageIndex = idx;

    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('page-' + pageName).classList.add('active');
    document.querySelectorAll('.nav-item')[idx].classList.add('active');

    if (pageName === 'drill') {
      updateGroupDropdown();
      renderDrillUI();
      updateReviewBadge();
    } else if (pageName === 'errors') {
      renderBubbleWall();
    }
  }

  let touchStartX = 0, touchStartY = 0;
  document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
  document.addEventListener('touchend', e => {
    const diffX = e.changedTouches[0].screenX - touchStartX;
    const diffY = e.changedTouches[0].screenY - touchStartY;
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
      if (diffX < 0 && currentPageIndex < pages.length - 1) switchPage(pages[currentPageIndex + 1]);
      else if (diffX > 0 && currentPageIndex > 0) switchPage(pages[currentPageIndex - 1]);
    }
  }, {passive: true});

  // --- æ ¸å¿ƒé€»è¾‘1ï¼šå¯¼å…¥/å½•å…¥ ---
  function handleImportWords(name, list) {
      // å®¹å™¨A: åŠ¨æ€æ± 
      wordLibrary[name] = [...list];
      // å®¹å™¨B: å¤‡ä»½æ±  (æ·±æ‹·è´)
      wordLibrary_copy[name] = JSON.parse(JSON.stringify(list));
      
      saveData();
      alert(`å·²å¯¼å…¥åˆ†ç»„: ${name}`);
      
      // è‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥ç»„
      isReviewMode = false;
      currentGroupName = name;
      currentQueue = [...wordLibrary[name]];
      
      updateGroupDropdown();
      activeWord = null;
      pickNextWord();
  }

  // --- æ ¸å¿ƒé€»è¾‘2ï¼šé”™é¢˜å¤„ç† (å…¥åº“ + ç«‹å³å¤ä¹ ) ---
  function handleMistake(wordObj) {
    const now = Date.now();
    const todayKey = getTodayKey();
    const copyKey = todayKey + '_copy';

    // 1. å…¥åº“ ErrorBook (å®¹å™¨E)
    const existing = errorBook.find(w => w.word === wordObj.word);
    if (existing) {
        existing.lastReview = now;
        existing.stage = 0; // æ‰“å›0çº§
    } else {
        errorBook.push({
            word: wordObj.word, def: wordObj.def, lastReview: now, stage: 0
        });
    }

    // 2. ç«‹å³åŠ å…¥ä»Šæ—¥å¤ä¹  (å®¹å™¨C) å’Œ å¤‡ä»½ (å®¹å™¨D) -> å®ç° Day 0 å¤ä¹ 
    let reviewList = JSON.parse(localStorage.getItem(todayKey) || '[]');
    let reviewCopy = JSON.parse(localStorage.getItem(copyKey) || '[]');

    // åˆ¤é‡ï¼Œé¿å…é‡å¤æ·»åŠ 
    if (!reviewList.some(w => w.word === wordObj.word)) {
        reviewList.push(wordObj);
    }
    // å¤‡ä»½åº“ä¹Ÿè¦åŠ ï¼Œå¦åˆ™åˆ†æ¯ä¼šå¯¹ä¸ä¸Š
    if (!reviewCopy.some(w => w.word === wordObj.word)) {
        reviewCopy.push(wordObj);
    }

    localStorage.setItem(todayKey, JSON.stringify(reviewList));
    localStorage.setItem(copyKey, JSON.stringify(reviewCopy));

    // 3. å¦‚æœå½“å‰æ­£åœ¨å¤ä¹ æ¨¡å¼ï¼Œå†…å­˜é˜Ÿåˆ—ä¹Ÿè¦åŠ 
    if (isReviewMode) {
        if (!currentQueue.some(w => w.word === wordObj.word)) {
            currentQueue.push(wordObj);
        }
    }
  }

  // --- æ ¸å¿ƒé€»è¾‘3ï¼šå¤ä¹ æŒ‰é’® (æ™ºèƒ½åˆ¤æ–­) ---
  document.getElementById("btnSmartReview").onclick = () => {
    const todayKey = getTodayKey();
    const copyKey = todayKey + '_copy';
    
    // è¯»å– Storage
    let storedList = JSON.parse(localStorage.getItem(todayKey) || '[]');
    let storedCopy = JSON.parse(localStorage.getItem(copyKey) || '[]'); // ä»…ä»…ç”¨æ¥åšåˆ†æ¯

    // é€»è¾‘ï¼šå¦‚æœä¸ä¸ºç©ºï¼Œç»§ç»­ï¼›å¦‚æœä¸ºç©ºï¼Œé‡ç®—
    if (storedList.length > 0) {
        // [A] ç»§ç»­æ¨¡å¼
        currentQueue = storedList;
        alert(`ç»§ç»­ä»Šæ—¥å¤ä¹ ï¼Œå‰©ä½™ ${storedList.length} ä¸ª`);
    } else {
        // [B] é‡ç®—æ¨¡å¼ (æ–°ä¸€è½®)
        const dueWords = calcDueWords();
        if (dueWords.length === 0) {
            alert("ä»Šæ—¥æš‚æ— å¾…å¤ä¹ å•è¯");
            return;
        }
        // è¦†ç›–å†™å…¥
        localStorage.setItem(todayKey, JSON.stringify(dueWords));
        localStorage.setItem(copyKey, JSON.stringify(dueWords));
        
        currentQueue = dueWords;
        alert(`å¼€å§‹æ–°ä¸€è½®å¤ä¹ ï¼Œå…± ${dueWords.length} ä¸ª`);
    }

    // åˆ‡æ¢çŠ¶æ€
    isReviewMode = true;
    currentGroupName = "ä»Šæ—¥å¤ä¹ ";
    updateGroupDropdown();
    activeWord = null;
    pickNextWord();
  };

  // --- æ ¸å¿ƒé€»è¾‘4ï¼šæ‹¼å†™æ­£ç¡® (ä¸åŒæ¨¡å¼ä¸åŒå¤„ç†) ---
  function handleCorrect(wordStr) {
    // UI åé¦ˆ
    const feedback = document.getElementById("wordInput");
    
    if (isReviewMode) {
        // --- å¤ä¹ æ¨¡å¼ ---
        // 1. å†…å­˜åˆ 
        currentQueue = currentQueue.filter(w => w.word !== wordStr);
        // 2. Storageåˆ  (å®¹å™¨C)
        const todayKey = getTodayKey();
        let list = JSON.parse(localStorage.getItem(todayKey) || '[]');
        list = list.filter(w => w.word !== wordStr);
        localStorage.setItem(todayKey, JSON.stringify(list));

        if (list.length === 0) setTimeout(() => alert("ğŸ‰ ä»Šæ—¥å¤ä¹ å®Œæˆï¼"), 300);

    } else {
        // --- æ™®é€šæ¨¡å¼ ---
        // 1. å†…å­˜åˆ 
        currentQueue = currentQueue.filter(w => w.word !== wordStr);
        // 2. åº“åˆ  (å®¹å™¨A)
        if (currentGroupName && wordLibrary[currentGroupName]) {
            wordLibrary[currentGroupName] = wordLibrary[currentGroupName].filter(w => w.word !== wordStr);
        }
    }
  }

  // --- UI: è¿›åº¦æ¡æ›´æ–° ---
  function updateProgressBar() {
    const disp = document.getElementById("progressDisplay");
    
    if (!activeWord) {
        disp.textContent = "0 / 0";
        return;
    }

    if (isReviewMode) {
        // å¤ä¹ æ¨¡å¼è¿›åº¦: (å®¹å™¨D - å®¹å™¨C) / å®¹å™¨D
        const todayKey = getTodayKey();
        const copyKey = todayKey + '_copy';
        // æ³¨æ„ï¼šè¿™é‡Œè¯»å–Storageæ˜¯ä¸ºäº†è·å–æœ€å®æ—¶çš„æ€»æ•°(åˆ†æ¯)ï¼Œå› ä¸ºé”™é¢˜ä¼šå¢åŠ åˆ†æ¯
        const list = JSON.parse(localStorage.getItem(todayKey) || '[]');
        const copy = JSON.parse(localStorage.getItem(copyKey) || '[]');
        
        const total = copy.length;
        const remain = list.length; // Storageé‡Œçš„å‰©ä½™æ•°åŒ…å«äº†å½“å‰çš„activeWord(å¦‚æœè¿˜æ²¡åˆ )
        // æ˜¾ç¤º: å·²å®Œæˆ / æ€»æ•°
        // ä¸ºäº†æ˜¾ç¤ºé€»è¾‘é¡ºç•…ï¼Œè¿™é‡Œç®€å•è®¡ç®—ï¼šæ€»æ•° - å‰©ä½™ (è¿‘ä¼¼å€¼ï¼Œå®é™…ä¸ŠactiveWordè¿˜åœ¨currentQueueé‡Œ)
        // ä¹Ÿå°±æ˜¯ï¼šå½“å‰æ˜¯ç¬¬å‡ ä¸ª
        // currentQueue.length ä»£è¡¨è¿˜æ²¡æ‹¼çš„(åŒ…å«å½“å‰)ï¼Œæ‰€ä»¥ done = total - currentQueue.length
        // æ˜¾ç¤ºä¸ºï¼š (done + 1) / total
        const done = total - currentQueue.length;
        disp.textContent = `${done + 1} / ${total}`;

    } else {
        // æ™®é€šæ¨¡å¼è¿›åº¦: (å®¹å™¨B - å®¹å™¨A) / å®¹å™¨B
        if (!currentGroupName || !wordLibrary_copy[currentGroupName]) {
            disp.textContent = "0 / 0"; return;
        }
        const total = wordLibrary_copy[currentGroupName].length;
        const remain = wordLibrary[currentGroupName].length; // è¿™é‡Œçš„remainå…¶å®å·²ç»åˆ é™¤äº†åˆšæ‰æ‹¼å¯¹çš„
        // ä½†æ˜¯ activeWord è¿˜åœ¨ç•Œé¢ä¸Šï¼ŒcurrentQueue è¿˜æ²¡ shift? ä¸ï¼ŒcurrentQueueæ˜¯å†…å­˜çš„
        // ç®€å•ç®—æ³•ï¼š total - currentQueue.length + 1
        const done = total - currentQueue.length;
        disp.textContent = `${done + 1} / ${total}`;
    }
  }

  // --- æŠ½è¯é€»è¾‘ (éšæœº) ---
  function pickNextWord() {
    const defDisplay = document.getElementById("definitionDisplay");
    const input = document.getElementById("wordInput");

    if (currentQueue.length === 0) {
      activeWord = null;
      defDisplay.textContent = "ğŸ‰ æœ¬ç»„å®Œæˆï¼";
      input.value = ""; input.disabled = true;
      updateProgressBar();
      saveData();
      return;
    }
    input.disabled = false;
    // éšæœº
    const idx = Math.floor(Math.random() * currentQueue.length);
    activeWord = currentQueue[idx];
    
    input.value = ""; input.focus();
    
    // UIæ¸²æŸ“
    if (activeWord) defDisplay.textContent = activeWord.def;
    updateProgressBar();
    saveData();
  }

  // --- äº‹ä»¶: è¾“å…¥æ¡†å›è½¦ ---
  document.getElementById("wordInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      if (!activeWord) return;
      const val = e.target.value.trim();

      if (val.toLowerCase() === activeWord.word.toLowerCase()) {
        // æ­£ç¡®
        handleCorrect(activeWord.word);
        
        // å¦‚æœåœ¨é”™é¢˜æœ¬ï¼Œæ›´æ–°Stage
        const errIdx = errorBook.findIndex(w => w.word === activeWord.word);
        if (errIdx !== -1) {
             errorBook[errIdx].lastReview = Date.now();
             errorBook[errIdx].stage = (errorBook[errIdx].stage || 0) + 1;
        }
        
        pickNextWord();

      } else {
        // é”™è¯¯
        const originalDef = activeWord.def;
        const correctWord = activeWord.word;
        const defDisplay = document.getElementById("definitionDisplay");
        defDisplay.textContent = `âŒ ${correctWord}`;
        defDisplay.style.color = "var(--danger)";
        
        handleMistake(activeWord);
        saveData();
        updateProgressBar(); // åˆ†æ¯å¯èƒ½å˜äº†

        setTimeout(() => {
            defDisplay.textContent = originalDef;
            defDisplay.style.color = "#1c1c1e";
            e.target.value = "";
        }, 1500);
      }
    }
  });

  // --- äº‹ä»¶: å¯¼å…¥ ---
  document.getElementById("btnImport").onclick = () => document.getElementById("fileInput").click();
  document.getElementById("fileInput").onchange = (e) => {
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
          const list = parseText(evt.target.result);
          if(list.length){
              const name = file.name.replace(/\.[^/.]+$/, "");
              handleImportWords(name, list);
          }
      };
      reader.readAsText(file);
  }

  // --- äº‹ä»¶: åˆ ç»„ ---
  document.getElementById("btnDelGroup").onclick = () => {
      if(!currentGroupName || isReviewMode) return;
      if(confirm(`åˆ é™¤åˆ†ç»„ "${currentGroupName}"ï¼Ÿ`)) {
          delete wordLibrary[currentGroupName];
          delete wordLibrary_copy[currentGroupName]; // åŒæ­¥åˆ Copy
          currentGroupName = ""; currentQueue = []; activeWord = null;
          saveData(); updateGroupDropdown(); 
          document.getElementById("definitionDisplay").textContent = "è¯·é€‰æ‹©åˆ†ç»„";
          updateProgressBar();
      }
  }

  // --- äº‹ä»¶: å½•å…¥ ---
  document.getElementById("btnConfirmInput").onclick = () => {
      const raw = document.getElementById("rawInput").value; const list = parseText(raw);
      if(list.length === 0) return alert("å†…å®¹ä¸ºç©º");
      const now = new Date();
      const name = `${String(now.getDate()).padStart(2,'0')}æ—¥_${String(now.getHours()).padStart(2,'0')}æ—¶${String(now.getMinutes()).padStart(2,'0')}åˆ†`;
      document.getElementById("rawInput").value = "";
      handleImportWords(name, list);
      switchPage('drill');
  }

  function parseText(text) {
      return text.split("\n").map(l => {
          const p = l.split(/[,ï¼Œ]/);
          return (p.length >= 2) ? { word: p[0].trim(), def: p.slice(1).join(",").trim() } : null;
      }).filter(x => x);
  }

  // --- äº‹ä»¶: é€‰ç»„ ---
  document.getElementById("groupSelectorSelect").addEventListener("change", (e) => {
    const name = e.target.value; if (!name) return;
    isReviewMode = false;
    currentGroupName = name;
    currentQueue = [...wordLibrary[name]];
    updateGroupDropdown(); activeWord = null; pickNextWord();
  });

  // --- UI: ä¸‹æ‹‰æ¡† ---
  function updateGroupDropdown() {
    const selector = document.getElementById("groupSelectorSelect");
    const label = document.getElementById("groupBtnLabel");
    selector.innerHTML = '<option value="">--</option>';
    for (let name in wordLibrary) {
      const option = document.createElement("option");
      option.value = name; option.textContent = name; selector.appendChild(option);
    }
    if (isReviewMode) {
        label.textContent = "å¤ä¹ ä¸­"; selector.value = ""; 
    } else if (currentGroupName && wordLibrary[currentGroupName]) {
        selector.value = currentGroupName;
        label.textContent = currentGroupName.length > 5 ? currentGroupName.substring(0,4)+'..' : currentGroupName;
    } else {
        label.textContent = "é€‰æ‹©åˆ†ç»„";
    }
  }

  function updateReviewBadge() {
    // ä»…è®¡ç®—å¾…å¤ä¹ æ•°ä½œä¸ºæç¤º
    const dueWords = calcDueWords();
    const count = dueWords.length;
    const countSpan = document.getElementById("reviewCount");
    if (count > 0) { countSpan.style.display = "inline"; countSpan.textContent = count; }
    else { countSpan.style.display = "none"; }
  }

  // --- Page 3: é”™é¢˜å¢™ ---
  function renderBubbleWall() {
    const container = document.getElementById("bubbleContainer"); container.innerHTML = ""; selectedErrorWord = null;
    if (errorBook.length === 0) { container.innerHTML = "<div style='width:100%;text-align:center;color:#999;margin-top:20px;'>æš‚æ— é”™é¢˜</div>"; return; }
    const sortedList = [...errorBook].sort((a, b) => b.lastReview - a.lastReview);
    sortedList.forEach(item => {
        const bubble = document.createElement("div"); bubble.className = "bubble"; bubble.textContent = item.word;
        bubble.onclick = () => { document.querySelectorAll('.bubble').forEach(b => b.classList.remove('selected')); bubble.classList.add('selected'); selectedErrorWord = item; };
        container.appendChild(bubble);
    });
  }

  // é”™é¢˜å¢™åˆ é™¤: è¿ååˆ é™¤ä»Šæ—¥å¾…å¤ä¹ 
  document.getElementById("btnErrorDelete").onclick = () => {
      if(!selectedErrorWord) return alert("è¯·å…ˆé€‰ä¸­");
      const wordToDelete = selectedErrorWord.word;
      
      // 1. åˆ é”™é¢˜æœ¬
      errorBook = errorBook.filter(w => w.word !== wordToDelete);
      
      // 2. åˆ ä»Šæ—¥å¤ä¹  (å®¹å™¨C)
      const todayKey = getTodayKey();
      let list = JSON.parse(localStorage.getItem(todayKey) || '[]');
      if (list.some(w => w.word === wordToDelete)) {
          list = list.filter(w => w.word !== wordToDelete);
          localStorage.setItem(todayKey, JSON.stringify(list));
      }
      
      saveData(); renderBubbleWall(); updateReviewBadge();
  };

  document.getElementById("btnErrorTravel").onclick = () => {
      if(!selectedErrorWord) return alert("è¯·å…ˆé€‰ä¸­");
      location.href = `eudic://dict/${selectedErrorWord.word}`;
  };

  // --- Page 1 Buttons ---
  document.getElementById("btnDeleteWord").onclick = () => {
    if (!activeWord) return;
    handleCorrect(activeWord.word); // é€»è¾‘ä¸Šç›¸å½“äºæ‹¼å¯¹ç§»é™¤
    saveData(); pickNextWord();
  };
  
  document.getElementById("btnTravel").onclick = () => { 
      if (activeWord) location.href = `eudic://dict/${activeWord.word}`; 
  };

  // å¯åŠ¨
  loadData(); switchPage('drill');
</script>
</body>
</html>
