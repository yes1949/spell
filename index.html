<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ä¸»é¡µ</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      box-sizing: border-box;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow: hidden;
    }

    .fixed-container {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 380px;
      position: relative;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #versionDisplay {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 5px;
      align-self: flex-start;
    }

    button, select, input[type="text"] {
      margin: 8px 4px;
      padding: 9px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      box-sizing: border-box;
      user-select: none;
    }

    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      min-width: 48px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      line-height: 1;
    }

    #importButton { background-color: #007bff; }
    #reviewButton { background-color: #ffc107; color: black; }
    #exportGroup { background-color: #17a2b8; }
    #deleteGroup { background-color: #dc3545; }

    #groupSelector {
      background-color: #28a745;
      color: white;
      min-width: 90px;
      max-width: 150px;
      height: 40px;
      font-size: 1rem;
      border-radius: 5px;
      padding: 0 6px;
    }

    #definitionDisplay {
      font-size: 1.3rem;
      margin: 15px 0 0;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      background-color: #e9ecef;
      padding: 12px 15px;
      border-radius: 5px;
      word-break: break-word;
      user-select: text;
      width: 100%;
      max-width: 350px;
    }

    #wordInput {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.2rem;
      border: 2px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      margin-top: 10px;
    }

    #wordInput:focus { border-color: #007bff; }

    #feedback {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      min-height: 20px;
      user-select: none;
      height: 24px;
    }

    .correct { color: green; }
    .wrong { color: red; }

    .button-group {
      display: flex;
      width: 100%;
      max-width: 380px;
      justify-content: center;
      flex-wrap: nowrap;
      gap: 8px;
      margin-top: 10px;
    }

    #nextWordGroup {
      margin-top: 10px;
      justify-content: center;
      width: 100%;
      max-width: 380px;
      display: flex;
      gap: 10px;
    }

    #nextWord, #deleteWord {
      flex: 1;
      height: 48px;
      font-size: 1.5rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      min-width: 0;
    }

    @media (max-width: 428px) {
      .fixed-container {
        max-width: 95vw;
        padding: 12px;
      }

      button, select, input[type="text"] {
        margin: 6px 3px;
        padding: 8px 10px;
        font-size: 0.95rem;
      }

      #groupSelector {
        min-width: 80px;
        max-width: 120px;
        height: 36px;
        font-size: 0.9rem;
      }

      #definitionDisplay {
        font-size: 1.1rem;
        min-height: 45px;
        padding: 10px 12px;
      }

      #wordInput {
        font-size: 1.05rem;
        padding: 10px 12px;
      }

      #feedback {
        margin-top: 8px;
        font-size: 1rem;
        min-height: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="fixed-container">
    <div id="versionDisplay">ç‰ˆæœ¬: 1.7.0 (æŠ½ç‰Œæ¨¡å¼)</div>
    <input type="file" id="fileInput" accept=".txt" style="display:none;" />
    <div class="button-group" id="topButtonsGroup">
      <button id="importButton" title="å¯¼å…¥">ğŸ“¥</button>
      <select id="groupSelector" title="é€‰æ‹©åˆ†ç»„"></select>
      <button id="reviewButton" title="å¤ä¹ ">ğŸ“…</button>
      <button id="exportGroup" title="å¯¼å‡º">ğŸ“¤</button>
      <button id="deleteGroup" title="åˆ é™¤">ğŸ—‘ï¸</button>
    </div>

    <div id="definitionDisplay">è¯·å¯¼å…¥æ–‡ä»¶æˆ–é€‰æ‹©åˆ†ç»„</div>
    <input type="text" id="wordInput" placeholder="åœ¨æ­¤è¾“å…¥" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <div id="feedback"></div>

    <div class="button-group" id="nextWordGroup">
      <button id="deleteWord" title="åˆ é™¤å½“å‰å•è¯" style="background-color: #007bff;">ğŸ—‘ï¸</button>
      <button id="nextWord" title="ä¸‹ä¸€ä¸ª" style="background-color: #28a745;">â¡ï¸</button>
    </div>

    <div style="margin-top:8px; font-size:0.9rem; color:#666;" id="progressDisplay"></div>
  </div>

<script>
  // æ ¸å¿ƒæ•°æ®ç»“æ„
  let wordGroups = {};          // æ‰€æœ‰çš„å•è¯åº“ï¼ˆåªè¯»ï¼Œé™¤éåˆ é™¤/å¯¼å…¥ï¼‰
  let currentGroup = "";        // å½“å‰é€‰æ‹©çš„åˆ†ç»„å
  let remainingWords = [];      // ã€å…³é”®å˜é‡ã€‘å½“å‰å‰©ä½™å¾…æ‹¼çš„å•è¯æ± 
  let currentActiveWord = null; // ã€å…³é”®å˜é‡ã€‘å½“å‰å±å¹•ä¸Šæ˜¾ç¤ºçš„è¿™ä¸ªå•è¯å¯¹è±¡
  let totalSessionWords = 0;    // æœ¬è½®æ€»æ•°ï¼ˆç”¨äºè®¡ç®—è¿›åº¦ï¼‰
  
  let errorWords = [];          // é”™è¯æœ¬ç¼“å­˜
  const defaultErrorGroupName = "é»˜è®¤ç»„";

  // 1. ä¿å­˜çŠ¶æ€ï¼šä¿å­˜æ‰€æœ‰æ ¸å¿ƒå˜é‡
  function saveToStorage() {
    const data = {
      wordGroups,
      currentGroup,
      remainingWords,
      currentActiveWord,
      totalSessionWords,
      errorWords
    };
    localStorage.setItem("wordData", JSON.stringify(data));
  }

  // 2. è¯»å–çŠ¶æ€
  function loadFromStorage() {
    const data = localStorage.getItem("wordData");
    if (data) {
      const parsed = JSON.parse(data);
      wordGroups = parsed.wordGroups || {};
      currentGroup = parsed.currentGroup || "";
      remainingWords = parsed.remainingWords || [];
      currentActiveWord = parsed.currentActiveWord || null;
      totalSessionWords = parsed.totalSessionWords || 0;
      errorWords = parsed.errorWords || [];
    }
  }

  function updateGroupSelector() {
    const selector = document.getElementById("groupSelector");
    selector.innerHTML = '<option value="">é€‰æ‹©åˆ†ç»„</option>';
    for (let group in wordGroups) {
      const option = document.createElement("option");
      option.value = group;
      option.textContent = group;
      selector.appendChild(option);
    }
    if(currentGroup) selector.value = currentGroup;
  }

  // 3. å¼€å§‹æ–°çš„ä¸€è½®ï¼ˆé‡ç½®æ¨¡å¼ï¼‰
  function startNewSession(groupName) {
    if (!wordGroups[groupName]) return;
    
    currentGroup = groupName;
    // å¤åˆ¶ä¸€ä»½åˆ°å‰©ä½™æ± 
    remainingWords = [...wordGroups[groupName]]; 
    totalSessionWords = remainingWords.length;
    currentActiveWord = null; // æ¸…ç©ºå½“å‰
    
    pickNextWord(); // æŠ½å–ç¬¬ä¸€ä¸ª
  }

  // 4. ã€æ ¸å¿ƒé€»è¾‘ã€‘ä»æ± å­é‡ŒæŠ½å–ä¸€ä¸ªå•è¯
  function pickNextWord() {
    const defBox = document.getElementById("definitionDisplay");
    const feedback = document.getElementById("feedback");
    const input = document.getElementById("wordInput");

    // å¦‚æœæ± å­ç©ºäº†
    if (remainingWords.length === 0) {
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„ï¼ˆå¦‚æœæ˜¯åˆšç­”å¯¹è¢«è®¾ä¸ºnulläº†ï¼Œé‚£å°±æ˜¯çœŸæ²¡äº†ï¼‰
      // å¦‚æœæ²¡æœ‰æ­£åœ¨æ˜¾ç¤ºçš„å•è¯ï¼Œè¯´æ˜å½»åº•ç»“æŸ
      currentActiveWord = null; 
      updateProgressDisplay();
      
      if (errorWords.length > 0) {
         if(confirm("æœ¬ç»„å·²å®Œæˆã€‚è¦ç«‹å³å¤ä¹ é”™è¯å—ï¼Ÿ")) {
             // è¿›å…¥å¤ä¹ æ¨¡å¼ï¼šæŠŠé”™è¯å½“æˆæ–°çš„ä¸€è½®
             remainingWords = [...errorWords];
             totalSessionWords = remainingWords.length;
             errorWords = []; // æ¸…ç©ºé”™è¯æœ¬å‡†å¤‡ä¸‹ä¸€è½®
             pickNextWord();
             return;
         }
      }
      defBox.textContent = "âœ… å…¨éƒ¨å®Œæˆï¼";
      input.value = "";
      feedback.textContent = "";
      saveToStorage();
      return;
    }

    // éšæœºæŠ½å–
    const randomIndex = Math.floor(Math.random() * remainingWords.length);
    // å–å‡ºå¹¶ä»æ•°ç»„ä¸­ç§»é™¤ (Splice returns an array, take [0])
    currentActiveWord = remainingWords.splice(randomIndex, 1)[0];
    
    saveToStorage(); // ç«‹å³ä¿å­˜ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±è¿›åº¦
    renderUI();
  }

  // 5. æ¸²æŸ“ç•Œé¢ï¼ˆæ ¹æ® currentActiveWordï¼‰
  function renderUI() {
    const defBox = document.getElementById("definitionDisplay");
    const feedback = document.getElementById("feedback");
    const input = document.getElementById("wordInput");
    
    updateProgressDisplay();

    if (currentActiveWord) {
      defBox.textContent = currentActiveWord.def;
    } else if (remainingWords.length === 0 && totalSessionWords > 0) {
       // é˜²æ­¢è¾¹ç•Œæƒ…å†µ
       defBox.textContent = "âœ… å®Œæˆ";
    } else {
       defBox.textContent = "è¯·é€‰æ‹©åˆ†ç»„";
    }

    input.value = "";
    input.focus();
    feedback.textContent = "";
  }

  function updateProgressDisplay() {
    const disp = document.getElementById("progressDisplay");
    if (totalSessionWords === 0) {
      disp.textContent = "";
      return;
    }
    // è¿›åº¦è®¡ç®—ï¼š æ€»æ•° - å‰©ä½™æ•°ã€‚
    // å¦‚æœå½“å‰å±å¹•ä¸Šæœ‰ä¸€ä¸ªè¯ï¼Œè¯´æ˜è¿™ä¸ªè¯è¿˜æ²¡â€œå®Œæˆâ€ï¼Œä½†åœ¨ pickNextWord é‡Œå®ƒå·²ç»è¢«ç§»å‡º remainingWords äº†ã€‚
    // æ‰€ä»¥é€»è¾‘ä¸Šï¼šå·²å®Œæˆ = æ€»æ•° - å‰©ä½™æ±  - (å½“å‰æ˜¯å¦æ˜¾ç¤º ? 1 : 0) ? ä¸ï¼Œç”¨æˆ·ä½“éªŒä¸Šï¼Œçœ‹åˆ°ç¬¬å‡ ä¸ªå°±æ˜¯ç¬¬å‡ ä¸ªã€‚
    // æ˜¾ç¤ºä¸ºï¼š ç¬¬ X ä¸ª / å…± Y ä¸ª
    // å½“å‰æ˜¯ç¬¬ (æ€» - å‰©ä½™) ä¸ª
    const currentCount = totalSessionWords - remainingWords.length;
    disp.textContent = `è¿›åº¦: ${currentCount} / ${totalSessionWords}`;
  }

  // --- äº‹ä»¶ç›‘å¬ ---

  document.getElementById("importButton").onclick = () => {
    document.getElementById("fileInput").click();
  };

  document.getElementById("fileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      const lines = e.target.result.split("\n").map(line => line.trim()).filter(Boolean);
      const wordList = [];
      for (let line of lines) {
        const parts = line.split(/[,ï¼Œ]/); // å…¼å®¹ä¸­è‹±æ–‡é€—å·
        if (parts.length >= 2) {
             const word = parts[0].trim();
             const def = parts.slice(1).join(",").trim();
             if (word && def) wordList.push({ word, def });
        }
      }
      if(wordList.length === 0) {
        alert("æ ¼å¼é”™è¯¯æˆ–æ–‡ä»¶ä¸ºç©º");
        return;
      }
      const name = file.name.replace(/\.[^/.]+$/, "");
      wordGroups[name] = wordList;
      saveToStorage();
      updateGroupSelector();
      // å¯¼å…¥åè‡ªåŠ¨å¼€å§‹
      startNewSession(name);
    };
    reader.readAsText(file);
  });

  // åˆ‡æ¢åˆ†ç»„ = å¼€å§‹æ–°çš„ä¸€è½®
  document.getElementById("groupSelector").addEventListener("change", function () {
    const group = this.value;
    if (group) startNewSession(group);
  });

  // è¾“å…¥åˆ¤æ–­
  document.getElementById("wordInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      if (!currentActiveWord) return;
      
      const input = this.value.trim();
      const feedback = document.getElementById("feedback");

      if (input.toLowerCase() === currentActiveWord.word.toLowerCase()) {
        feedback.textContent = "âœ” æ­£ç¡®";
        feedback.className = "correct";
        
        // ç¨å¾®å»¶æ—¶ä¸€ç‚¹ç‚¹è®©ç”¨æˆ·çœ‹åˆ°å¯¹å·ï¼ˆå¯é€‰ï¼‰ï¼Œæˆ–è€…ç›´æ¥ä¸‹ä¸€ä¸ª
        // è¿™é‡Œé€‰æ‹©ç›´æ¥ä¸‹ä¸€ä¸ªï¼Œä¿æŒæµç•…
        pickNextWord();
      } else {
        feedback.textContent = `âœ˜ é”™è¯¯ï¼š${currentActiveWord.word}`;
        feedback.className = "wrong";
        
        // è®°å½•é”™è¯åˆ°é»˜è®¤ç»„
        if (!wordGroups[defaultErrorGroupName]) wordGroups[defaultErrorGroupName] = [];
        if (!wordGroups[defaultErrorGroupName].some(w => w.word === currentActiveWord.word)) {
          wordGroups[defaultErrorGroupName].push(currentActiveWord);
          if(!errorWords.some(w => w.word === currentActiveWord.word)) {
             errorWords.push(currentActiveWord);
          }
          saveToStorage();
          updateGroupSelector();
        }
        this.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†è®©ç”¨æˆ·é‡è¾“
      }
    }
  });

  // ä¸‹ä¸€ä¸ªæŒ‰é’®ï¼ˆè·³è¿‡ï¼‰
  document.getElementById("nextWord").onclick = () => {
    if (!currentActiveWord && remainingWords.length === 0) return;
    pickNextWord();
  };

  // åˆ é™¤å•è¯
  document.getElementById("deleteWord").addEventListener("click", () => {
    if (!currentActiveWord || !currentGroup) return;

    // 1. ä»ä¸»åº“ä¸­æ°¸ä¹…åˆ é™¤
    if(wordGroups[currentGroup]) {
        wordGroups[currentGroup] = wordGroups[currentGroup].filter(w => w.word !== currentActiveWord.word);
    }
    
    // 2. æ— éœ€ä» remainingWords åˆ é™¤ï¼Œå› ä¸ºå®ƒå·²ç»è¢«ç§»å‡ºå»äº†å¹¶åœ¨ currentActiveWord é‡Œ
    // 3. ç›´æ¥æŠ½å–ä¸‹ä¸€ä¸ªï¼Œè¦†ç›–å½“å‰çš„ currentActiveWord
    pickNextWord();
  });

  // å¤ä¹ é”™è¯
  document.getElementById("reviewButton").onclick = () => {
    if (!wordGroups[defaultErrorGroupName] || wordGroups[defaultErrorGroupName].length === 0) {
      alert("æš‚æ— é”™è¯");
      return;
    }
    // å¤ä¹ ä¹Ÿæ˜¯ä¸€ç§ startNewSession
    startNewSession(defaultErrorGroupName);
    updateGroupSelector();
  };

  document.getElementById("deleteGroup").onclick = () => {
    if (!currentGroup) return;
    if (confirm("ç¡®å®šåˆ é™¤å½“å‰åˆ†ç»„ï¼Ÿ")) {
      delete wordGroups[currentGroup];
      currentGroup = "";
      remainingWords = [];
      currentActiveWord = null;
      totalSessionWords = 0;
      saveToStorage();
      updateGroupSelector();
      renderUI();
    }
  };

  document.getElementById("exportGroup").onclick = () => {
    if (!currentGroup || !wordGroups[currentGroup]) return;
    const text = wordGroups[currentGroup].map(w => `${w.word},${w.def}`).join("\n");
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${currentGroup}.txt`;
    a.click();
  };

  // --- åˆå§‹åŒ–é€»è¾‘ ---
  loadFromStorage();
  updateGroupSelector();

  // æ¢å¤ç°åœºé€»è¾‘ï¼š
  // å¦‚æœæœ‰æ­£åœ¨æ˜¾ç¤ºçš„è¯ï¼Œæˆ–è€…æ± å­é‡Œè¿˜æœ‰è¯ï¼Œå°±æ¢å¤ç•Œé¢
  if (currentActiveWord || (remainingWords && remainingWords.length > 0)) {
     renderUI();
  } else {
     // é—²ç½®çŠ¶æ€
     document.getElementById("definitionDisplay").textContent = "è¯·å¯¼å…¥æ–‡ä»¶æˆ–é€‰æ‹©åˆ†ç»„";
  }

  // è§†å£è°ƒæ•´
  if(window.visualViewport){
    const fixedContainer = document.querySelector('.fixed-container');
    window.visualViewport.addEventListener('resize', ()=>{ fixedContainer.style.top = '0px'; });
    window.visualViewport.addEventListener('scroll', ()=>{ window.scrollTo(0,0); });
  }
</script>
</body>
</html>
