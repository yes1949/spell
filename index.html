<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>è®°å¿†åŸå‹ Max</title>
  <style>
    :root {
      --primary: #5ac8fa;
      --active-blue: #007aff;
      --danger: #ff3b30; /* åˆ é™¤æŒ‰é’®è­¦ç¤ºçº¢ */
      --bg-color: #f2f2f7; /* iOS ç³»ç»Ÿçº§èƒŒæ™¯ç° */
      --card-bg: #ffffff;
      --bubble-bg: #81cafa;
      --btn-radius: 22px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆª (é¿å¼€åˆ˜æµ·å±) */
    .nav-bar {
      padding-top: env(safe-area-inset-top); /* å…³é”®ï¼šé€‚é…åˆ˜æµ· */
      height: calc(44px + env(safe-area-inset-top));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 17px;
      background: var(--card-bg);
      border-bottom: 0.5px solid #c6c6c8;
      z-index: 100;
    }

    /* ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* é€‚é…åº•éƒ¨é»‘æ¡ */
    }

    .page {
      display: none;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }
    .page.active { display: flex; }

    button {
      border: none;
      outline: none;
      background: var(--primary);
      color: white;
      font-size: 15px; /* Max å±å¹•å¤§ï¼Œå­—å·ç¨å¤§ */
      font-weight: 600;
      padding: 0;
      border-radius: var(--btn-radius);
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button:active { opacity: 0.7; transform: scale(0.98); }

    /* --- Page 1: æ‹¼å†™ --- */
    
    .top-controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 25px; /* æ‹‰å¤§é—´è· */
    }
    
    .pill-btn {
      flex: 1;
      height: 40px; /* åŠ é«˜æŒ‰é’®ä¾¿äºç‚¹å‡» */
      border-radius: 20px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    #groupSelectorSelect {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0;
    }

    /* æç¤ºåŒº - å……åˆ†åˆ©ç”¨ Max çš„é«˜åº¦ */
    .prompt-area {
      background: #e1f5fe;
      color: #1c1c1e;
      border-radius: 24px;
      padding: 30px 20px;
      flex: 1; /* å æ®ä¸­é—´å‰©ä½™ç©ºé—´ */
      max-height: 40%; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 22px; /* å¤§å±å¤§å­— */
      font-weight: 700;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      word-break: break-word;
    }

    /* è¾“å…¥åŒº */
    .input-wrapper {
      margin-bottom: 40px; 
      width: 100%;
      text-align: center;
    }
    
    /* ç§»é™¤äº† .input-label */

    #wordInput {
      width: 100%;
      border: none;
      border-bottom: 2px solid #c7c7cc;
      font-size: 32px; /* è¶…å¤§è¾“å…¥å­—å· */
      text-align: center;
      padding: 10px 0;
      background: transparent;
      outline: none;
      color: #000;
      border-radius: 0;
      font-family: monospace; /* ç­‰å®½å­—ä½“æ–¹ä¾¿å¯¹é½ */
    }
    #wordInput:focus { border-bottom-color: var(--active-blue); }

    /* åº•éƒ¨æŒ‰é’® */
    .bottom-actions {
      display: flex;
      justify-content: space-between;
      margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
      padding-bottom: 10px;
    }
    
    .bottom-btn {
      width: 120px; /* æ›´å®½çš„æŒ‰é’® */
      height: 50px; /* æ›´é«˜çš„æŒ‰é’® */
      border-radius: 25px;
      font-size: 17px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* --- Page 2: å½•å…¥ --- */
    .input-page-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      padding-top: 20px;
    }

    #rawInput {
      width: 100%;
      flex: 1; /* å¡«æ»¡ç©ºé—´ */
      background: #ffffff;
      border: 1px solid #e5e5ea;
      border-radius: 24px;
      padding: 20px;
      font-size: 17px;
      line-height: 1.5;
      resize: none;
      outline: none;
      margin-bottom: 20px;
      color: #333;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    }

    .save-btn {
      width: 100%;
      height: 56px; /* å¤§æŒ‰é’® */
      font-size: 18px;
      border-radius: 28px;
      background: var(--active-blue);
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
      margin-bottom: 10px;
    }

    /* --- Page 3: é”™é¢˜ --- */
    #bubbleContainer {
      flex: 1;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
      gap: 12px;
      justify-content: center;
      overflow: hidden; /* è¶…å‡ºéšè— */
      padding: 10px 0;
    }

    .bubble {
      background: var(--bubble-bg);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      cursor: pointer;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s;
    }
    .bubble.selected {
      background: var(--active-blue);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,122,255,0.4);
    }

    .error-bottom-actions {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding-bottom: 10px;
    }

    /* TabBar */
    .tab-bar {
      height: calc(50px + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      border-top: 0.5px solid #c6c6c8;
      display: flex;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px); /* æ¯›ç»ç’ƒæ•ˆæœ */
      justify-content: space-around;
      align-items: center;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 200;
    }
    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      color: #999;
      width: 60px;
      padding-top: 5px;
    }
    .tab-item.active { color: var(--active-blue); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }

    /* Main Content Padding Fix for TabBar */
    .main-content { padding-bottom: calc(60px + env(safe-area-inset-bottom)); }

    #feedbackDisplay {
        height: 24px; 
        font-size: 16px; 
        text-align: center; 
        margin-top: 15px;
        font-weight: 700;
        letter-spacing: 1px;
    }
    .correct { color: #34c759; }
    .wrong { color: #ff3b30; }

    #fileInput { display: none; }
  </style>
</head>
<body>

  <div class="nav-bar">
    <span id="pageTitle">å•è¯æ‹¼å†™</span>
  </div>

  <div class="main-content">

    <div id="page-drill" class="page active">
      
      <div class="top-controls">
        <button class="pill-btn" id="btnImport">å¯¼å…¥</button>
        <div class="pill-btn">
          <span id="groupBtnLabel">é€‰æ‹©åˆ†ç»„</span>
          <select id="groupSelectorSelect"></select>
        </div>
        <button class="pill-btn" id="btnDelGroup">åˆ åˆ†ç»„</button>
        <button class="pill-btn" id="btnSmartReview">å¤ä¹  <span id="reviewCount" style="display:none;font-weight:800;margin-left:4px"></span></button>
      </div>

      <div class="prompt-area" id="definitionDisplay">
        è¯·é€‰æ‹©åˆ†ç»„å¼€å§‹
      </div>

      <div class="input-wrapper">
        <input type="text" id="wordInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="åœ¨æ­¤è¾“å…¥" />
        <div id="feedbackDisplay"></div>
      </div>

      <div class="bottom-actions">
        <button class="bottom-btn" id="btnDeleteWord" style="background:var(--danger); color:white; box-shadow: 0 4px 12px rgba(255,59,48,0.3);">ğŸ—‘ï¸ åˆ é™¤</button>
        <button class="bottom-btn" id="btnTravel" style="background:var(--primary)">ğŸš€ ç©¿è¶Š</button>
      </div>
      
      <input type="file" id="fileInput" accept=".txt">
    </div>

    <div id="page-input" class="page">
      <div class="input-page-container">
        <textarea id="rawInput" placeholder="åœ¨æ­¤ç²˜è´´å•è¯...&#10;æ ¼å¼ï¼šå•è¯,å®šä¹‰&#10;ä¾‹å¦‚ï¼š&#10;apple,è‹¹æœ&#10;banana,é¦™è•‰"></textarea>
        <button class="save-btn" id="btnConfirmInput">ä¿å­˜åˆ°æ–°åˆ†ç»„</button>
      </div>
    </div>

    <div id="page-errors" class="page">
      <div id="bubbleContainer"></div>
      <div class="error-bottom-actions">
        <button class="bottom-btn" id="btnErrorDelete" style="background:var(--danger); flex:1">åˆ é™¤é€‰ä¸­</button>
        <button class="bottom-btn" id="btnErrorTravel" style="background:var(--primary); flex:1">ç©¿è¶Šé€‰ä¸­</button>
      </div>
    </div>

  </div>

  <div class="tab-bar">
    <div class="tab-item active" onclick="switchPage('drill')">
      <span class="tab-icon">ğŸ“</span>
      <span>ç»ƒä¹ </span>
    </div>
    <div class="tab-item" onclick="switchPage('input')">
      <span class="tab-icon">â•</span>
      <span>å½•å…¥</span>
    </div>
    <div class="tab-item" onclick="switchPage('errors')">
      <span class="tab-icon">ğŸ§¼</span>
      <span>é”™é¢˜å¢™</span>
    </div>
  </div>

<script>
  // --- æ•°æ®æ ¸å¿ƒ ---
  const REVIEW_INTERVALS = [1, 2, 4, 7, 15, 30, 60, 90, 120];
  let wordLibrary = {}; 
  let errorBook = []; 
  let currentQueue = [];
  
  let currentGroupName = ""; 
  let activeWord = null;     
  let selectedErrorWord = null;
  let isReviewMode = false;

  function loadData() {
    const data = localStorage.getItem("myCardsData_Max");
    if (data) {
      const parsed = JSON.parse(data);
      wordLibrary = parsed.wordLibrary || {};
      errorBook = parsed.errorBook || [];
      errorBook.forEach(w => {
        if (!w.lastReview) w.lastReview = Date.now();
        if (typeof w.stage === 'undefined') w.stage = 0;
      });
      currentQueue = parsed.currentQueue || [];
      currentGroupName = parsed.currentGroupName || "";
      isReviewMode = parsed.isReviewMode || false;
      activeWord = parsed.activeWord || null;
    }
  }

  function saveData() {
    const data = { wordLibrary, errorBook, currentQueue, currentGroupName, isReviewMode, activeWord };
    localStorage.setItem("myCardsData_Max", JSON.stringify(data));
    updateReviewCount();
  }

  function switchPage(pageName) {
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('page-' + pageName).classList.add('active');
    
    const idx = ['drill', 'input', 'errors'].indexOf(pageName);
    if(document.querySelectorAll('.tab-item')[idx]) {
        document.querySelectorAll('.tab-item')[idx].classList.add('active');
    }

    if (pageName === 'drill') {
      updateGroupDropdown();
      renderDrillUI();
      updateReviewCount();
    } else if (pageName === 'errors') {
      renderBubbleWall();
    }
  }

  // --- Page 1 é€»è¾‘ ---

  function updateGroupDropdown() {
    const selector = document.getElementById("groupSelectorSelect");
    const label = document.getElementById("groupBtnLabel");
    selector.innerHTML = '<option value="">--</option>';
    for (let name in wordLibrary) {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      selector.appendChild(option);
    }
    if (!isReviewMode && currentGroupName && wordLibrary[currentGroupName]) {
      selector.value = currentGroupName;
      label.textContent = currentGroupName.length > 6 ? currentGroupName.substring(0,5)+'...' : currentGroupName;
    } else {
      label.textContent = "é€‰æ‹©åˆ†ç»„";
    }
  }

  document.getElementById("groupSelectorSelect").addEventListener("change", (e) => {
    const name = e.target.value;
    if (!name) return;
    isReviewMode = false;
    currentGroupName = name;
    document.getElementById("groupBtnLabel").textContent = name;
    currentQueue = [...wordLibrary[name]];
    activeWord = null;
    pickNextWord();
  });

  function updateReviewCount() {
    const now = Date.now();
    const count = errorBook.filter(w => {
        const stage = w.stage || 0;
        const intervalDays = stage < REVIEW_INTERVALS.length ? REVIEW_INTERVALS[stage] : 120;
        return (now - w.lastReview) >= (intervalDays * 86400000);
    }).length;
    const countSpan = document.getElementById("reviewCount");
    if (count > 0) {
        countSpan.style.display = "inline";
        countSpan.textContent = count;
    } else {
        countSpan.style.display = "none";
    }
  }

  document.getElementById("btnSmartReview").onclick = () => {
    const now = Date.now();
    const dueWords = errorBook.filter(w => {
        const stage = w.stage || 0;
        const intervalDays = stage < REVIEW_INTERVALS.length ? REVIEW_INTERVALS[stage] : 120;
        return (now - w.lastReview) >= (intervalDays * 86400000);
    });
    if (dueWords.length === 0) {
        alert("ä»Šæ—¥æš‚æ— éœ€è¦å¤ä¹ çš„å•è¯");
        return;
    }
    isReviewMode = true;
    currentGroupName = "å¤ä¹ æ¨¡å¼";
    document.getElementById("groupBtnLabel").textContent = "å¤ä¹ ä¸­";
    currentQueue = [...dueWords];
    activeWord = null;
    pickNextWord();
  };

  function pickNextWord() {
    const defDisplay = document.getElementById("definitionDisplay");
    const input = document.getElementById("wordInput");
    const feedback = document.getElementById("feedbackDisplay");

    if (currentQueue.length === 0) {
      activeWord = null;
      defDisplay.textContent = "ğŸ‰ æœ¬ç»„å®Œæˆï¼";
      input.value = "";
      input.disabled = true;
      feedback.textContent = "";
      saveData();
      return;
    }
    input.disabled = false;
    // éšæœºå–è¯
    const idx = Math.floor(Math.random() * currentQueue.length);
    activeWord = currentQueue[idx];
    
    input.value = "";
    input.focus();
    feedback.textContent = "";
    renderDrillUI();
    saveData();
  }

  function renderDrillUI() {
    const defDisplay = document.getElementById("definitionDisplay");
    if (activeWord) {
      defDisplay.textContent = activeWord.def;
    } else if (!currentGroupName) {
        defDisplay.textContent = "ğŸ‘† è¯·å…ˆé€‰æ‹©åˆ†ç»„";
    }
  }

  document.getElementById("wordInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      if (!activeWord) return;
      const val = e.target.value.trim();
      const feedback = document.getElementById("feedbackDisplay");

      if (val.toLowerCase() === activeWord.word.toLowerCase()) {
        feedback.textContent = "âœ” æ­£ç¡®";
        feedback.className = "correct";
        // æ‹¼å¯¹ç§»é™¤
        currentQueue = currentQueue.filter(w => w.word !== activeWord.word);
        
        const errIdx = errorBook.findIndex(w => w.word === activeWord.word);
        if (errIdx !== -1) {
             errorBook[errIdx].lastReview = Date.now();
             errorBook[errIdx].stage = (errorBook[errIdx].stage || 0) + 1;
        }
        setTimeout(pickNextWord, 400);
      } else {
        feedback.textContent = `âœ˜ ${activeWord.word}`;
        feedback.className = "wrong";
        e.target.value = "";
        
        const now = Date.now();
        const existing = errorBook.find(w => w.word === activeWord.word);
        if (existing) {
            existing.lastReview = now;
            existing.stage = 0;
        } else {
            errorBook.push({
                word: activeWord.word, 
                def: activeWord.def,
                lastReview: now,
                stage: 0
            });
        }
        saveData();
      }
    }
  });

  // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ é™¤å½“å‰å•è¯é€»è¾‘ ---
  document.getElementById("btnDeleteWord").onclick = () => {
    if (!activeWord) return;
    
    const wordToDelete = activeWord.word;
    
    // 1. ä»å½“å‰é˜Ÿåˆ—åˆ é™¤ (UIç«‹å³ç”Ÿæ•ˆ)
    currentQueue = currentQueue.filter(w => w.word !== wordToDelete);
    
    // 2. ä»æ°¸ä¹…åº“åˆ é™¤ (å¦‚æœæ˜¯æ™®é€šæ¨¡å¼)
    if (!isReviewMode && currentGroupName && wordLibrary[currentGroupName]) {
        wordLibrary[currentGroupName] = wordLibrary[currentGroupName].filter(w => w.word !== wordToDelete);
    }
    
    // 3. åé¦ˆä¸ä¸‹ä¸€ä¸ª
    const feedback = document.getElementById("feedbackDisplay");
    feedback.textContent = "ğŸ—‘ï¸ å·²åˆ é™¤";
    feedback.className = "wrong"; // ç”¨çº¢è‰²æ˜¾ç¤º
    
    saveData();
    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹å†è·³ä¸‹ä¸€ä¸ªï¼Œè®©ç”¨æˆ·çŸ¥é“åˆ æˆåŠŸäº†
    setTimeout(() => {
        pickNextWord();
    }, 300);
  };
  
  document.getElementById("btnTravel").onclick = () => {
    if (activeWord) doTravel(activeWord.word);
  };
  
  document.getElementById("btnImport").onclick = () => document.getElementById("fileInput").click();
  document.getElementById("fileInput").onchange = (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
          const list = parseText(evt.target.result);
          if(list.length){
              const name = file.name.replace(/\.[^/.]+$/, "");
              wordLibrary[name] = list;
              saveData();
              updateGroupDropdown();
              alert("å¯¼å…¥æˆåŠŸ");
          }
      };
      reader.readAsText(file);
  }
  
  document.getElementById("btnDelGroup").onclick = () => {
      if(!currentGroupName || isReviewMode) return;
      if(confirm(`ç¡®å®šåˆ é™¤åˆ†ç»„ "${currentGroupName}"ï¼Ÿ`)) {
          delete wordLibrary[currentGroupName];
          currentGroupName = "";
          currentQueue = [];
          activeWord = null;
          saveData();
          updateGroupDropdown();
          renderDrillUI();
      }
  }

  // --- Page 2 å½•å…¥ ---
  function parseText(text) {
      return text.split("\n").map(l => {
          const p = l.split(/[,ï¼Œ]/);
          return (p.length >= 2) ? { word: p[0].trim(), def: p.slice(1).join(",").trim() } : null;
      }).filter(x => x);
  }

  document.getElementById("btnConfirmInput").onclick = () => {
      const raw = document.getElementById("rawInput").value;
      const list = parseText(raw);
      if(list.length === 0) return alert("æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º");
      
      const now = new Date();
      const name = `${String(now.getDate()).padStart(2,'0')}æ—¥_${String(now.getHours()).padStart(2,'0')}æ—¶${String(now.getMinutes()).padStart(2,'0')}åˆ†`;
      
      wordLibrary[name] = list;
      document.getElementById("rawInput").value = "";
      saveData();
      alert(`å·²ä¿å­˜ ${list.length} ä¸ªå•è¯`);
      switchPage('drill');
      
      isReviewMode = false;
      currentGroupName = name;
      updateGroupDropdown();
      document.getElementById("groupBtnLabel").textContent = name;
      currentQueue = [...list];
      activeWord = null;
      pickNextWord();
  }

  // --- Page 3 é”™é¢˜ ---
  function renderBubbleWall() {
    const container = document.getElementById("bubbleContainer");
    container.innerHTML = "";
    selectedErrorWord = null;
    
    if (errorBook.length === 0) {
        container.innerHTML = "<div style='width:100%;text-align:center;color:#999;margin-top:40px;'>æš‚æ— é”™é¢˜ï¼ŒçœŸæ£’ï¼</div>";
        return;
    }

    const sortedList = [...errorBook].sort((a, b) => b.lastReview - a.lastReview);

    sortedList.forEach(item => {
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = item.word;
        bubble.onclick = () => {
            document.querySelectorAll('.bubble').forEach(b => b.classList.remove('selected'));
            bubble.classList.add('selected');
            selectedErrorWord = item;
        };
        container.appendChild(bubble);
    });
  }

  document.getElementById("btnErrorDelete").onclick = () => {
      if(!selectedErrorWord) return alert("è¯·ç‚¹å‡»æ°”æ³¡é€‰ä¸­ä¸€ä¸ªå•è¯");
      errorBook = errorBook.filter(w => w.word !== selectedErrorWord.word);
      saveData();
      renderBubbleWall();
      updateReviewCount();
  };

  document.getElementById("btnErrorTravel").onclick = () => {
      if(!selectedErrorWord) return alert("è¯·ç‚¹å‡»æ°”æ³¡é€‰ä¸­ä¸€ä¸ªå•è¯");
      doTravel(selectedErrorWord.word);
  };

  function doTravel(word) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(word).then(() => {
            location.href = `eudic://dict/${word}`;
        }).catch(() => { location.href = `eudic://dict/${word}`; });
      } else {
        location.href = `eudic://dict/${word}`;
      }
  }

  // å¯åŠ¨
  loadData();
  switchPage('drill');

</script>
</body>
</html>
